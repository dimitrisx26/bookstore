<div class="container py-5 text-center">
  <!-- Hero -->
  <h1 class="h4 fw-bold mb-2">Search to find your new book</h1>
  <p class="text-muted mb-3">
    Search for books by title, author, or ISBN to find your next great read.
  </p>
  <!-- END Hero -->

  <!-- Search input -->
  <div class="row justify-content-center">
    <div class="col-md-8 d-flex align-items-center gap-3">
      <div class="search-container d-flex flex-grow-1">
        <input
          #searchInput
          id="search-input"
          name="search"
          type="text"
          class="form-control search-input flex-grow-1"
          placeholder="Search..."
          (input)="onSearch(searchInput.value)"
        />
        <i class="bi bi-search search-icon"></i>
      </div>
      <!-- END Search input -->

      <!-- Add modal button opener -->
      <button
        aria-label="Add a new book"
        class="btn btn-primary rounded-4 p-2 flex-shrink-0 d-inline-flex"
        data-bs-toggle="modal"
        data-bs-target="#addModal"
        style="min-width: 0; width: auto;"
      >
        <i
          class="bi bi-plus-lg me-2"
          aria-hidden="true"
        ></i>
        Add Book
      </button>
      <!-- END Add modal button opener -->
    </div>
  </div>

  <!-- Filters -->
  <form class="container mt-4" role="search" aria-label="Book filters">
    <div class="row g-2 align-items-center filters-row justify-content-center">
      <div class="col-12 col-sm-6 col-md-3">
        <label class="visually-hidden" for="category-filter">Category</label>
        <div class="input-group">
          <span class="input-group-text d-flex align-items-center justify-content-center"><i class="bi bi-tags" aria-hidden="true"></i></span>
          <select #categorySelect id="category-filter" name="category" class="form-select" aria-label="category filter" (change)="onFilterChange('category', categorySelect.value)">
            <option value="all" selected>All categories</option>
            @for (category of categories(); track category) {
              <option value="{{ category }}">{{ category }}</option>
            }
          </select>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <label class="visually-hidden" for="year-filter">Year</label>
        <div class="input-group">
          <span class="input-group-text d-flex align-items-center justify-content-center"><i class="bi bi-calendar3" aria-hidden="true"></i></span>
          <select #yearSelect id="year-filter" name="year" class="form-select" aria-label="year filter" (change)="onFilterChange('year', yearSelect.value)">
            <option value="all" selected>All years</option>
            @for (year of years(); track year) {
              <option value="{{ year }}">{{ year }}</option>
            }
          </select>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <label class="visually-hidden" for="publisher-filter">Publisher</label>
        <div class="input-group">
          <span class="input-group-text d-flex align-items-center justify-content-center"><i class="bi bi-building" aria-hidden="true"></i></span>
          <select #publisherSelect id="publisher-filter" name="publisher" class="form-select" aria-label="publisher filter" (change)="onFilterChange('publisher', publisherSelect.value)">
            <option value="all" selected>All publishers</option>
            @for (publisher of publishers(); track publisher) {
              <option value="{{ publisher }}">{{ publisher }}</option>
            }
          </select>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-3">
        <label class="visually-hidden" for="rating-filter">Rating</label>
        <div class="input-group">
          <span class="input-group-text d-flex align-items-center justify-content-center"><i class="bi bi-star" aria-hidden="true"></i></span>
          <select #ratingSelect id="rating-filter" name="rating" class="form-select" aria-label="rating filter" (change)="onFilterChange('rating', ratingSelect.value)">
            <option value="all" selected>All ratings</option>
            <option value="1">1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
          </select>
        </div>
      </div>
    </div>
  </form>
  <!-- END Filters -->

  <!-- Results -->
  <div class="container pt-5">
    <div class="row g-4 justify-content-start">
      <!-- Loading state -->
      @if (loading()) {
        <div class="text-center">
          <p class="text-muted">Loading...</p>
        </div>
      }
      <!-- END Loading state -->
      @else {
        <!-- Empty state -->
        @if (books() && books().length === 0) {
          <div class="text-center">
            <p class="text-muted">No books found.</p>
          </div>
        }
        <!-- END Empty state -->
        @else {
          <!-- Books loop -->
          @for (book of books(); track book.id) {
            <!-- Book column -->
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
              <!-- Book card -->
              <div
                class="card book-card border-0 rounded-4 shadow-sm h-100 d-flex flex-column clickable-card"
                (click)="viewBookDetails(book.id)"
                role="button"
                tabindex="0"
                [attr.aria-label]="'View details for ' + book.title"
                (keydown.enter)="viewBookDetails(book.id)"
                (keydown.space)="viewBookDetails(book.id)"
              >
                <!-- Card image -->
                <div
                  class="ratio bg-light overflow-hidden p-2"
                  style="--bs-aspect-ratio: 75%"
                >
                  <div
                    class="d-flex align-items-center justify-content-center h-100 w-100"
                  >
                    <img
                      src="{{ book.imageUrl }}"
                      class="img-fluid"
                      alt="{{ book.title }} cover"
                      style="
                        object-fit: contain;
                        max-height: 100%;
                        width: auto;
                        display: block;
                      "
                    />
                  </div>
                </div>
                <!-- END Card image / media -->

                <!-- Card body -->
                <div class="card-body p-3 d-flex flex-column flex-grow-1">
                  <!-- Title / author -->
                  <h5 class="card-title fw-bold mb-1" title="{{ book.title }}">
                    {{ book.title }}
                  </h5>
                  <h6
                    class="card-subtitle text-muted mb-2 small text-truncate"
                    title="{{ book.authors }}"
                  >
                    {{ book.authors }}
                  </h6>
                  <!-- END Title / author -->

                  <!-- Categories -->
                  <div class="mb-2 categories-preview">
                    @if (book.categories && book.categories.length && typeof book.categories !== 'string' ) {
                      @for (category of book.categories.slice(0,2); track category) {
                        <span
                          class="badge bg-secondary small py-1 px-2 me-1 text-truncate"
                          style="max-width: 8rem"
                          title="{{ category }}"
                          >{{ category }}</span
                        >
                      }

                      @if (book.categories.length > 2) {
                        <details class="categories-details">
                          <summary class="categories-summary">+{{ book.categories.length - 2 }} more</summary>
                          <div class="mt-2 d-flex flex-column gap-1">
                            @for (cat of book.categories; track cat) {
                              <span class="badge bg-secondary small py-1 px-2" title="{{ cat }}">{{ cat }}</span>
                            }
                          </div>
                        </details>
                      }
                    } @else {
                      <span class="badge bg-secondary small py-1 px-2" title="Category">{{ book.categories || 'Uncategorized' }}</span>
                    }
                  </div>
                  <!-- END Categories -->

                  <!-- Rating and average -->
                  <div
                    class="mt-auto d-flex justify-content-between align-items-center gap-2"
                  >
                    <span
                      class="rating d-flex align-items-center gap-1"
                      aria-label="Rating"
                    >
                      @for (i of [1,2,3,4,5]; track i) {
                        @if (book.averageRating >= i) {
                          <i class="bi bi-star-fill text-warning" aria-hidden="true"></i>
                        } @else {
                          @if (book.averageRating >= i - 0.5) {
                            <i class="bi bi-star-half text-warning" aria-hidden="true"></i>
                          } @else {
                            <i class="bi bi-star text-warning" aria-hidden="true"></i>
                          }
                        }
                      }
                    </span>

                    <div
                      class="badge bg-light text-dark border rounded-pill py-1 px-2"
                      title="Average rating"
                    >
                      <span class="fw-semibold small">{{ book.averageRating || '-' }}</span>
                    </div>
                  </div>
                  <!-- END Rating and average -->

                </div>
                <!-- END Card body -->

              </div>
              <!-- END Book card -->
            </div>
            <!-- END Book column -->
          }
          <!-- END SubBooks loop -->
        }
      }
    </div>
  </div>
  <!-- END Results -->
</div>

<!-- Add Book Modal -->
<app-book-create-component></app-book-create-component>
<!-- End Add Book Modal -->
